# Screenshot Event åˆ’åˆ†æœºåˆ¶çš„å…³é”®é—®é¢˜åˆ†æ

æœ¬æ–‡æ¡£ä»åº”ç”¨å±‚é¢å’Œç³»ç»Ÿç¨³å®šæ€§è§’åº¦ï¼Œæ‰¹åˆ¤æ€§åœ°åˆ†æå½“å‰å®ç°çš„æ½œåœ¨é—®é¢˜å’Œé£é™©ã€‚

## ä¸€ã€å¹¶å‘å’Œç«æ€æ¡ä»¶é—®é¢˜ï¼ˆä¸¥é‡ï¼‰

### 1.1 åŒä¸€äº‹ä»¶çš„å¹¶å‘æ›´æ–°å†²çª

**é—®é¢˜æè¿°**ï¼š
å½“å¤šä¸ªæ‰¹æ¬¡çš„ screenshots åŒæ—¶åˆ°è¾¾ï¼Œä¸”éƒ½è¯†åˆ«ä¸ºåŒä¸€äº‹ä»¶æ—¶ï¼Œä¼šäº§ç”Ÿå¹¶å‘æ›´æ–°å†²çªã€‚

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: Screenshots 1-20 åˆ°è¾¾ â†’ LLM åˆ¤æ–­ï¼šmerge(event_123)
T2: Screenshots 21-40 åˆ°è¾¾ â†’ LLM åˆ¤æ–­ï¼šmerge(event_123)  
T3: Screenshots 41-60 åˆ°è¾¾ â†’ LLM åˆ¤æ–­ï¼šmerge(event_123)

å¦‚æœ T1, T2, T3 å‡ ä¹åŒæ—¶åˆ°è¾¾ï¼ˆç”±äºç½‘ç»œå»¶è¿Ÿã€é˜Ÿåˆ—å¤„ç†ç­‰ï¼‰ï¼Œ
ä¸‰ä¸ª merge æ“ä½œå¯èƒ½åŒæ—¶æ‰§è¡Œï¼Œå¯¼è‡´ï¼š
- æœ€åä¸€ä¸ªå†™å…¥è¦†ç›–å‰ä¸¤ä¸ªçš„æ›´æ–°ï¼ˆä¸¢å¤±æ•°æ®ï¼‰
- Summary è¢«é”™è¯¯è¦†ç›–ï¼ˆæœ€åä¸€ä¸ªå†™å…¥çš„ summary å¯èƒ½ä¸åŒ…å«å‰é¢çš„ä¿¡æ¯ï¼‰
```

**ä»£ç è¯æ®**ï¼š
```python
# mirix/services/episodic_memory_manager.py:1362
def update_event(self, event_id: str = None, new_summary: str = None, 
                 new_details: str = None, actor: PydanticClient = None):
    with self.session_maker() as session:
        selected_event = EpisodicEvent.read(db_session=session, identifier=event_id, actor=actor)
        if new_summary:
            selected_event.summary = new_summary  # âš ï¸ ç›´æ¥è¦†ç›–ï¼Œæ²¡æœ‰ç‰ˆæœ¬æ£€æŸ¥
        if new_details:
            selected_event.details += "\n" + new_details  # âš ï¸ å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒéåŸå­æ“ä½œ
        selected_event.update_with_redis(session, actor=actor)
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ **æ²¡æœ‰ä¹è§‚é”/æ‚²è§‚é”æœºåˆ¶**ï¼šå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶è¯»å–åŒä¸€äº‹ä»¶ï¼Œç„¶åå„è‡ªæ›´æ–°
- âŒ **éåŸå­æ“ä½œ**ï¼š`details += "\n" + new_details` å­˜åœ¨ Read-Modify-Write ç«æ€
- âŒ **Summary è¦†ç›–ä¸¢å¤±**ï¼šå¦‚æœ LLM å¿˜è®°åœ¨ combined_summary ä¸­åŒ…å«æ—§ä¿¡æ¯ï¼Œæ•°æ®ä¼šæ°¸ä¹…ä¸¢å¤±

**å½±å“**ï¼š
- ğŸ”´ **æ•°æ®ä¸¢å¤±é£é™©**ï¼šé«˜
- ğŸ”´ **æ•°æ®ä¸€è‡´æ€§**ï¼šä¸¥é‡ç ´å
- ğŸ”´ **ç”¨æˆ·ä½“éªŒ**ï¼šè®°å¿†ä¸å®Œæ•´æˆ–ä¸å‡†ç¡®

---

### 1.2 ç¼ºå°‘äº‹åŠ¡éš”ç¦»çº§åˆ«æ§åˆ¶

**é—®é¢˜æè¿°**ï¼š
ä»£ç ä¸­ä½¿ç”¨ `with self.session_maker() as session:`ï¼Œä½†æ²¡æœ‰æ˜ç¡®æŒ‡å®šéš”ç¦»çº§åˆ«ã€‚

**æ½œåœ¨é—®é¢˜**ï¼š
- åœ¨ PostgreSQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆREAD COMMITTEDï¼‰ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°ï¼š
  - **Lost Update**ï¼šä¸¤ä¸ªäº‹åŠ¡éƒ½è¯»å–æ—§å€¼ï¼Œéƒ½æ›´æ–°ï¼Œåä¸€ä¸ªè¦†ç›–å‰ä¸€ä¸ª
  - **Non-repeatable Read**ï¼šåŒä¸€äº‹åŠ¡ä¸­ä¸¤æ¬¡è¯»å–åŒä¸€äº‹ä»¶ï¼Œç»“æœä¸ä¸€è‡´

**ä»£ç ä½ç½®**ï¼š
```python
# mirix/services/episodic_memory_manager.py:1379
with self.session_maker() as session:
    selected_event = EpisodicEvent.read(...)  # æ²¡æœ‰ SELECT ... FOR UPDATE
    # ... ä¿®æ”¹ ...
    selected_event.update_with_redis(session, actor=actor)  # commit
```

**å»ºè®®ä¿®å¤**ï¼š
```python
# åº”è¯¥ä½¿ç”¨æ‚²è§‚é”
selected_event = session.query(EpisodicEvent).filter(
    EpisodicEvent.id == event_id
).with_for_update().one()  # SELECT ... FOR UPDATE
```

---

## äºŒã€æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆä¸¥é‡ï¼‰

### 2.1 Summary è¦†ç›–å¯¼è‡´çš„ä¿¡æ¯ä¸¢å¤±

**é—®é¢˜æè¿°**ï¼š
`episodic_memory_merge` çš„ `combined_summary` **å®Œå…¨è¦†ç›–**æ—§çš„ summaryï¼Œå¦‚æœ LLM ç”Ÿæˆçš„ summary ä¸åŒ…å«æ—§ä¿¡æ¯ï¼Œä¼šå¯¼è‡´å†å²ä¿¡æ¯æ°¸ä¹…ä¸¢å¤±ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/functions/function_sets/memory_tools.py:149
def episodic_memory_merge(self: "Agent", event_id: str, 
                          combined_summary: str = None, 
                          combined_details: str = None):
    # ...
    episodic_memory = self.episodic_memory_manager.update_event(
        event_id=event_id,
        new_summary=combined_summary,  # âš ï¸ ç›´æ¥è¦†ç›–
        new_details=combined_details,
        actor=self.actor,
    )
```

**Prompt è­¦å‘Š**ï¼š
```
Note that the new summary will overwrite the old summary so make sure 
to include the information from the old summary.
```
ä½†è¿™æ˜¯**è¢«åŠ¨è­¦å‘Š**ï¼Œä¾èµ– LLM çš„æ­£ç¡®è¡Œä¸ºï¼Œæ²¡æœ‰æœºåˆ¶ä¿è¯ã€‚

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
åˆå§‹äº‹ä»¶ï¼š
Summary: "John is watching the movie 'Inception' on Netflix"

LLM é”™è¯¯ç”Ÿæˆçš„ combined_summary: "User continues watching movie"
ï¼ˆå¿˜è®°åŒ…å«ç”µå½±åç§°å’Œå¹³å°ä¿¡æ¯ï¼‰

ç»“æœï¼šå†å²ä¿¡æ¯æ°¸ä¹…ä¸¢å¤±ï¼
```

**å½±å“**ï¼š
- ğŸ”´ **æ•°æ®å®Œæ•´æ€§**ï¼šä¸¥é‡é£é™©
- ğŸ”´ **ä¸å¯æ¢å¤**ï¼šä¸€æ—¦è¦†ç›–ï¼Œæ— æ³•æ¢å¤åŸå§‹ summary
- ğŸŸ¡ **LLM ä¾èµ–æ€§**ï¼šå®Œå…¨ä¾èµ– LLM çš„æ­£ç¡®è¡Œä¸º

---

### 2.2 Details è¿½åŠ æ“ä½œçš„ç«æ€æ¡ä»¶

**é—®é¢˜æè¿°**ï¼š
`details += "\n" + new_details` æ˜¯å…¸å‹çš„ Read-Modify-Write æ“ä½œï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ä¼šä¸¢å¤±æ›´æ–°ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/services/episodic_memory_manager.py:1396
if new_details:
    selected_event.details += "\n" + new_details  # âš ï¸ éåŸå­æ“ä½œ
```

**å¹¶å‘åœºæ™¯**ï¼š
```
äº‹åŠ¡ A: è¯»å– details = "Content A"
äº‹åŠ¡ B: è¯»å– details = "Content A"
äº‹åŠ¡ A: details = "Content A\nContent B" â†’ commit
äº‹åŠ¡ B: details = "Content A\nContent C" â†’ commit  # è¦†ç›–äº† Content B
ç»“æœï¼šä¸¢å¤±äº† Content B
```

**å½±å“**ï¼š
- ğŸ”´ **æ•°æ®ä¸¢å¤±**ï¼šå¹¶å‘åœºæ™¯ä¸‹å¿…ç„¶å‘ç”Ÿ
- ğŸ”´ **ä¸¥é‡æ€§**ï¼šé«˜é¢‘æ“ä½œï¼ˆæ¯ç§’å¯èƒ½æœ‰å¤šæ¬¡æ›´æ–°ï¼‰

---

### 2.3 Redis ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
ä»£ç ä¸­åŒæ—¶æ›´æ–° PostgreSQL å’Œ Redisï¼Œä½†å¦‚æœ Redis æ›´æ–°å¤±è´¥ï¼Œä¼šå¯¼è‡´ç¼“å­˜ä¸ä¸€è‡´ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/orm/sqlalchemy_base.py:766
def update_with_redis(self, db_session: "Session", actor=None, use_cache=True):
    with db_session as session:
        session.add(self)
        session.commit()  # âœ… æ•°æ®åº“æäº¤æˆåŠŸ
        
        if use_cache:
            self._update_redis_cache(operation="update", actor=actor)  
            # âš ï¸ å¦‚æœè¿™é‡Œå¤±è´¥ï¼ŒRedis ç¼“å­˜è¿‡æœŸï¼Œä½†æ•°æ®åº“å·²æ›´æ–°
```

**æ½œåœ¨é—®é¢˜**ï¼š
- Redis æ›´æ–°å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ã€Redis å®•æœºï¼‰æ—¶ï¼Œç¼“å­˜ä¼šè¿‡æœŸ
- åç»­è¯»å–å¯èƒ½ä» Redis è·å–è¿‡æœŸæ•°æ®ï¼Œæˆ–ä»æ•°æ®åº“è·å–æ–°æ•°æ®ï¼ˆä¸ä¸€è‡´ï¼‰

**å½±å“**ï¼š
- ğŸŸ¡ **ç¼“å­˜ä¸€è‡´æ€§**ï¼šä¸­ç­‰é£é™©
- ğŸŸ¡ **æ€§èƒ½å½±å“**ï¼šç¼“å­˜å¤±æ•ˆå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™

---

## ä¸‰ã€é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶ï¼ˆä¸­ç­‰ï¼‰

### 3.1 LLM åˆ¤æ–­é”™è¯¯æ— æ³•çº æ­£

**é—®é¢˜æè¿°**ï¼š
å¦‚æœ LLM é”™è¯¯åœ°åˆ¤æ–­äº†äº‹ä»¶çš„è¿ç»­æ€§ï¼ˆåº”è¯¥ merge ä½†ç”¨äº† insertï¼Œæˆ–ç›¸åï¼‰ï¼Œç³»ç»Ÿæ²¡æœ‰è‡ªåŠ¨çº æ­£æœºåˆ¶ã€‚

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
åœºæ™¯ 1ï¼šåº”è¯¥ mergeï¼Œä½†ç”¨äº† insert
- ç»“æœï¼šåŒä¸€æ´»åŠ¨è¢«è®°å½•ä¸ºå¤šä¸ªç‹¬ç«‹äº‹ä»¶
- å½±å“ï¼šäº‹ä»¶ç¢ç‰‡åŒ–ï¼Œéš¾ä»¥æ£€ç´¢å’Œç†è§£

åœºæ™¯ 2ï¼šåº”è¯¥ insertï¼Œä½†ç”¨äº† merge
- ç»“æœï¼šæ–°æ´»åŠ¨è¢«é”™è¯¯åœ°åˆå¹¶åˆ°æ—§äº‹ä»¶
- å½±å“ï¼šäº‹ä»¶æ··æ·†ï¼Œæ—¶é—´çº¿æ··ä¹±
```

**å½“å‰æœºåˆ¶**ï¼š
- âŒ æ²¡æœ‰éªŒè¯æœºåˆ¶æ£€æŸ¥åˆ¤æ–­æ˜¯å¦æ­£ç¡®
- âŒ æ²¡æœ‰åç»­çš„åˆå¹¶/æ‹†åˆ†æœºåˆ¶
- âš ï¸ ä¾èµ– Reflexion Agent äº‹åæ¸…ç†ï¼ˆè¢«åŠ¨ä¸”ä¸å¯é ï¼‰

---

### 3.2 é”™è¯¯åçš„æ•°æ®æ¢å¤å›°éš¾

**é—®é¢˜æè¿°**ï¼š
å¦‚æœ merge æ“ä½œå¤±è´¥ï¼ˆå¦‚ event_id ä¸å­˜åœ¨ã€æƒé™é—®é¢˜ç­‰ï¼‰ï¼Œç³»ç»Ÿæ²¡æœ‰å›æ»šæˆ–è¡¥å¿æœºåˆ¶ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/services/episodic_memory_manager.py:1386
if not selected_event:
    raise ValueError(f"Episodic episodic_memory record with id {event_id} not found.")
# âš ï¸ æŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ²¡æœ‰å¤„ç†å·²éƒ¨åˆ†æ›´æ–°çš„çŠ¶æ€
```

**é—®é¢˜**ï¼š
- å¦‚æœ `new_details` å·²ç» append åˆ° detailsï¼Œä½†åç»­æ“ä½œå¤±è´¥ï¼Œæ•°æ®å¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€
- æ²¡æœ‰äº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆè™½ç„¶ SQLAlchemy æœ‰ï¼Œä½†æ²¡æœ‰æ˜ç¡®çš„é”™è¯¯å¤„ç†ç­–ç•¥ï¼‰

---

### 3.3 Event ID æ— æ•ˆæ—¶çš„å¤„ç†

**é—®é¢˜æè¿°**ï¼š
Agent ä¾èµ– system prompt ä¸­çš„ event_idï¼Œä½†å¦‚æœï¼š
1. Event å·²è¢«åˆ é™¤
2. Event ä¸å±äºå½“å‰ç”¨æˆ·/ç»„ç»‡
3. Event ID æ ¼å¼é”™è¯¯

ç³»ç»Ÿä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ²¡æœ‰é™çº§ç­–ç•¥ï¼ˆå¦‚åˆ›å»ºæ–°äº‹ä»¶ï¼‰ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/functions/function_sets/memory_tools.py:167
episodic_memory = self.episodic_memory_manager.update_event(
    event_id=event_id,  # âš ï¸ å¦‚æœ event_id æ— æ•ˆï¼Œç›´æ¥å¤±è´¥
    ...
)
```

---

## å››ã€æ€§èƒ½å’Œå¯æ‰©å±•æ€§é—®é¢˜ï¼ˆä¸­ç­‰ï¼‰

### 4.1 å•æ¬¡è°ƒç”¨é™åˆ¶å¯¼è‡´çš„æ•ˆç‡é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
æ¯ä¸ª Agent æ¯æ‰¹ screenshots åªèƒ½æ‰§è¡Œ**ä¸€ä¸ª**æ“ä½œï¼Œè¿™æ„å‘³ç€ï¼š
- å¦‚æœä¸€æ‰¹ screenshots åŒ…å«å¤šä¸ªä¸åŒçš„äº‹ä»¶ï¼Œåªèƒ½å¤„ç†æœ€é‡è¦çš„ä¸€ä¸ª
- å…¶ä»–äº‹ä»¶éœ€è¦ç­‰åˆ°ä¸‹ä¸€æ‰¹æ‰èƒ½å¤„ç†
- å¢åŠ äº†å»¶è¿Ÿå’Œå¤æ‚åº¦

**åœºæ™¯ç¤ºä¾‹**ï¼š
```
Screenshots 1-20 æ˜¾ç¤ºï¼š
- å‰ 10 å¼ ï¼šç»§ç»­è§‚çœ‹ç”µå½± A
- å 10 å¼ ï¼šåˆ‡æ¢åˆ°å†™ä»£ç 

æ ¹æ® "prioritize the most significant activity"ï¼Œå¯èƒ½åªå¤„ç†å…¶ä¸­ä¸€ä¸ªï¼Œ
å¦ä¸€ä¸ªéœ€è¦ç­‰å¾…ä¸‹ä¸€æ‰¹ï¼ˆå¯èƒ½ 20 ç§’åï¼‰ï¼Œå¯¼è‡´æ—¶é—´æˆ³ä¸å‡†ç¡®ã€‚
```

**å½±å“**ï¼š
- ğŸŸ¡ **å»¶è¿Ÿå¢åŠ **ï¼šäº‹ä»¶è®°å½•ä¸åŠæ—¶
- ğŸŸ¡ **å‡†ç¡®æ€§ä¸‹é™**ï¼šæ—¶é—´æˆ³å¯èƒ½ä¸å‡†ç¡®

---

### 4.2 System Prompt é•¿åº¦é™åˆ¶

**é—®é¢˜æè¿°**ï¼š
ç³»ç»Ÿæä¾›æœ€å¤š 10 ä¸ªæœ€è¿‘äº‹ä»¶å’Œ 10 ä¸ªç›¸å…³äº‹ä»¶ï¼Œä½†ï¼š
- å¯¹äºæ´»è·ƒç”¨æˆ·ï¼Œå¯èƒ½æœ‰å¤§é‡äº‹ä»¶
- LLM åªèƒ½çœ‹åˆ°æœ‰é™çš„å†å²ä¸Šä¸‹æ–‡
- å¯èƒ½å¯¼è‡´è¯¯åˆ¤ï¼ˆå¦‚è®¤ä¸ºåº”è¯¥ mergeï¼Œä½†å®é™…ä¸Šæœ€è¿‘çš„äº‹ä»¶å·²è¿‡æœŸï¼‰

**ä»£ç è¯æ®**ï¼š
```python
# mirix/constants.py
MAX_RETRIEVAL_LIMIT_IN_SYSTEM = 10  # åªæœ‰ 10 ä¸ª

# mirix/agent/agent.py:2279
limit=MAX_RETRIEVAL_LIMIT_IN_SYSTEM,  # æœ€å¤š 10 ä¸ªæœ€è¿‘äº‹ä»¶
```

**å½±å“**ï¼š
- ğŸŸ¡ **ä¸Šä¸‹æ–‡ä¸å®Œæ•´**ï¼šLLM å¯èƒ½çœ‹ä¸åˆ°çœŸæ­£ç›¸å…³çš„äº‹ä»¶
- ğŸŸ¡ **è¯¯åˆ¤é£é™©**ï¼šå¢åŠ é”™è¯¯çš„ merge/insert åˆ¤æ–­

---

### 4.3 Details å­—æ®µæ— é™å¢é•¿

**é—®é¢˜æè¿°**ï¼š
`details` å­—æ®µé€šè¿‡ `+= "\n" + new_details` ä¸æ–­è¿½åŠ ï¼Œæ²¡æœ‰å¤§å°é™åˆ¶æˆ–å‹ç¼©æœºåˆ¶ã€‚

**æ½œåœ¨é—®é¢˜**ï¼š
- é•¿æœŸè¿è¡Œåï¼Œdetails å¯èƒ½å˜å¾—éå¸¸å¤§ï¼ˆå‡ ä¸‡å­—ç¬¦ï¼‰
- å½±å“æ•°æ®åº“æ€§èƒ½ï¼ˆæŸ¥è¯¢ã€ç´¢å¼•ã€ä¼ è¾“ï¼‰
- å½±å“ LLM å¤„ç†æ•ˆç‡ï¼ˆtoken æ¶ˆè€—ï¼‰

**å½“å‰é™åˆ¶**ï¼š
```
Avoid appending to events with more than 5000 characters in details 
- use episodic_memory_insert instead
```
ä½†è¿™æ˜¯**è¢«åŠ¨å»ºè®®**ï¼Œæ²¡æœ‰å¼ºåˆ¶æœºåˆ¶ã€‚

**å½±å“**ï¼š
- ğŸŸ¡ **æ€§èƒ½ä¸‹é™**ï¼šå¤§å­—æ®µå½±å“æŸ¥è¯¢æ€§èƒ½
- ğŸŸ¡ **æˆæœ¬å¢åŠ **ï¼šLLM token æ¶ˆè€—å¢åŠ 

---

## äº”ã€è®¾è®¡ç¼ºé™·ï¼ˆä¸­ç­‰ï¼‰

### 5.1 è¿‡åº¦ä¾èµ– LLM çš„å¯é æ€§

**é—®é¢˜æè¿°**ï¼š
æ•´ä¸ªäº‹ä»¶åˆ’åˆ†æœºåˆ¶å®Œå…¨ä¾èµ– LLM çš„è¯­ä¹‰ç†è§£ï¼Œæ²¡æœ‰ç¡¬æ€§çš„è§„åˆ™æˆ–éªŒè¯æœºåˆ¶ã€‚

**é£é™©**ï¼š
- LLM å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„åˆ¤æ–­ï¼ˆç›¸åŒåœºæ™¯ï¼Œä¸åŒæ—¶é—´ç»™å‡ºä¸åŒç»“æœï¼‰
- LLM å¯èƒ½å¿½ç•¥ prompt ä¸­çš„è­¦å‘Šï¼ˆå¦‚å¿˜è®°åœ¨ summary ä¸­åŒ…å«æ—§ä¿¡æ¯ï¼‰
- LLM å¯èƒ½äº§ç”Ÿæ ¼å¼é”™è¯¯ï¼ˆå¦‚ event_id æ ¼å¼é”™è¯¯ï¼‰

**å½“å‰ç¼“è§£æªæ–½**ï¼š
- âš ï¸ åªæœ‰ prompt ä¸­çš„è­¦å‘Š
- âš ï¸ æ²¡æœ‰è¾“å…¥éªŒè¯
- âš ï¸ æ²¡æœ‰è¾“å‡ºéªŒè¯

---

### 5.2 ç¼ºä¹æ˜ç¡®çš„äº‹ä»¶è¾¹ç•Œå®šä¹‰

**é—®é¢˜æè¿°**ï¼š
ç³»ç»Ÿæ²¡æœ‰æ˜ç¡®å®šä¹‰"ä»€ä¹ˆæ˜¯åŒä¸€äº‹ä»¶"çš„è§„åˆ™ï¼Œå®Œå…¨ä¾èµ– LLM çš„åˆ¤æ–­ã€‚

**æ¨¡ç³Šç‚¹**ï¼š
- æ—¶é—´é—´éš”å¤šå°‘ç®—åŒä¸€äº‹ä»¶ï¼Ÿï¼ˆ1 ç§’ï¼Ÿ1 åˆ†é’Ÿï¼Ÿ1 å°æ—¶ï¼Ÿï¼‰
- æ´»åŠ¨åˆ‡æ¢åå¤šä¹…ç®—æ–°äº‹ä»¶ï¼Ÿ
- æš‚åœåæ¢å¤æ˜¯å¦ç®—åŒä¸€äº‹ä»¶ï¼Ÿ

**å½±å“**ï¼š
- ğŸŸ¡ **ä¸ä¸€è‡´æ€§**ï¼šä¸åŒæ—¶é—´å¯èƒ½äº§ç”Ÿä¸åŒçš„åˆ’åˆ†ç»“æœ
- ğŸŸ¡ **ä¸å¯é¢„æµ‹**ï¼šç”¨æˆ·æ— æ³•é¢„æœŸäº‹ä»¶å¦‚ä½•è¢«åˆ’åˆ†

---

### 5.3 å•æ‰¹æ¬¡å¤„ç†çš„å±€é™æ€§

**é—®é¢˜æè¿°**ï¼š
æ¯æ‰¹ screenshotsï¼ˆçº¦ 20 å¼ ï¼‰åªèƒ½å½±å“ä¸€ä¸ª eventï¼Œè¿™ç§è®¾è®¡é™åˆ¶äº†ç³»ç»Ÿçš„çµæ´»æ€§ã€‚

**é—®é¢˜åœºæ™¯**ï¼š
1. **äº‹ä»¶è¾¹ç•Œåœ¨æ‰¹æ¬¡ä¸­é—´**ï¼š
   ```
   Screenshots 1-10: è§‚çœ‹ç”µå½± A
   Screenshots 11-20: å¼€å§‹è§‚çœ‹ç”µå½± B
   
   åªèƒ½å¤„ç†ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¼šè¢«å¿½ç•¥æˆ–å»¶è¿Ÿ
   ```

2. **å¤šä¸ªå¹¶è¡Œæ´»åŠ¨**ï¼š
   ```
   Screenshots åŒæ—¶æ˜¾ç¤ºï¼š
   - ä¸»çª—å£ï¼šå†™ä»£ç 
   - ä¾§è¾¹æ ï¼šèŠå¤©æ¶ˆæ¯
   - é€šçŸ¥ï¼šæ–°é‚®ä»¶
   
   åªèƒ½è®°å½•æœ€é‡è¦çš„ä¸€ä¸ª
   ```

---

## å…­ã€ç³»ç»Ÿç¨³å®šæ€§é—®é¢˜ï¼ˆä¸­ç­‰ï¼‰

### 6.1 æ•°æ®åº“é”å®šé—®é¢˜

**é—®é¢˜æè¿°**ï¼š
è™½ç„¶ä»£ç ä¸­æœ‰ `transaction_retry` è£…é¥°å™¨å¤„ç†æ•°æ®åº“é”å®šï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä»å¯èƒ½å¤±è´¥ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/orm/sqlalchemy_base.py:766
@transaction_retry(max_retries=5, base_delay=0.1, max_delay=3.0)
def update_with_redis(...):
    # æœ€å¤šé‡è¯• 5 æ¬¡ï¼Œä½†å¦‚æœå¹¶å‘å¾ˆé«˜ï¼Œä»å¯èƒ½å¤±è´¥
```

**åœºæ™¯**ï¼š
- å¦‚æœå¤šä¸ª Agent åŒæ—¶æ›´æ–°ä¸åŒçš„äº‹ä»¶ï¼Œä½†éƒ½æ¶‰åŠç›¸åŒçš„è¡¨ï¼Œå¯èƒ½å¯¼è‡´é”å®š
- SQLite çš„é”å®šæœºåˆ¶è¾ƒå¼±ï¼Œæ›´å®¹æ˜“å‡ºç°é—®é¢˜

**å½±å“**ï¼š
- ğŸŸ¡ **å¯ç”¨æ€§ä¸‹é™**ï¼šé«˜å¹¶å‘æ—¶å¯èƒ½å‡ºç°å¤§é‡é‡è¯•å’Œå¤±è´¥
- ğŸŸ¡ **æ€§èƒ½ä¸‹é™**ï¼šé‡è¯•æœºåˆ¶å¢åŠ å»¶è¿Ÿ

---

### 6.2 ç¼ºå°‘ç›‘æ§å’Œå‘Šè­¦

**é—®é¢˜æè¿°**ï¼š
ç³»ç»Ÿæ²¡æœ‰ç›‘æ§æœºåˆ¶æ¥æ£€æµ‹ï¼š
- å¹¶å‘å†²çªé¢‘ç‡
- æ•°æ®ä¸¢å¤±æƒ…å†µ
- LLM åˆ¤æ–­é”™è¯¯ç‡
- æ€§èƒ½æŒ‡æ ‡ï¼ˆå¤„ç†å»¶è¿Ÿã€æˆåŠŸç‡ç­‰ï¼‰

**å½±å“**ï¼š
- ğŸ”´ **å¯è§‚æµ‹æ€§å·®**ï¼šé—®é¢˜éš¾ä»¥å‘ç°å’Œå®šä½
- ğŸ”´ **è¢«åŠ¨å“åº”**ï¼šåªèƒ½åœ¨ç”¨æˆ·æŠ¥å‘Šé—®é¢˜åæ‰å‘ç°

---

### 6.3 é”™è¯¯ä¼ æ’­å’Œéš”ç¦»

**é—®é¢˜æè¿°**ï¼š
å¦‚æœæŸä¸ª Memory Agent å¤„ç†å¤±è´¥ï¼Œå¯èƒ½ä¼šå½±å“å…¶ä»– Agent çš„å¤„ç†ã€‚

**ä»£ç è¯æ®**ï¼š
```python
# mirix/functions/function_sets/memory_tools.py:1091
with ThreadPoolExecutor(max_workers=max_workers) as executor:
    # å¦‚æœæŸä¸ª Agent å¤±è´¥ï¼Œä¼šå¦‚ä½•å½±å“å…¶ä»– Agentï¼Ÿ
    for future in as_completed(future_to_index):
        try:
            responses[index] = future.result()
        except Exception as exc:
            raise RuntimeError(...)  # âš ï¸ å¯èƒ½å½±å“æ•´ä¸ªæ‰¹æ¬¡
```

**é—®é¢˜**ï¼š
- å¦‚æœ Episodic Agent å¤±è´¥ï¼Œå…¶ä»– Agentï¼ˆå¦‚ Knowledge Agentï¼‰çš„å¤„ç†ç»“æœå¯èƒ½ä¹Ÿä¼šå—å½±å“
- æ²¡æœ‰éƒ¨åˆ†æˆåŠŸæœºåˆ¶ï¼ˆéƒ¨åˆ† Agent æˆåŠŸï¼Œéƒ¨åˆ†å¤±è´¥ï¼‰

---

## ä¸ƒã€æ€»ç»“å’Œå»ºè®®

### ä¸¥é‡é—®é¢˜ï¼ˆéœ€è¦ç«‹å³ä¿®å¤ï¼‰

1. **å¹¶å‘æ›´æ–°å†²çª**ï¼šéœ€è¦å®ç°ä¹è§‚é”æˆ–æ‚²è§‚é”
2. **Summary è¦†ç›–ä¸¢å¤±**ï¼šéœ€è¦ç‰ˆæœ¬æ§åˆ¶æˆ–åˆå¹¶ç­–ç•¥
3. **Details è¿½åŠ ç«æ€**ï¼šéœ€è¦åŸå­æ“ä½œæˆ–é”å®šæœºåˆ¶

### ä¸­ç­‰é—®é¢˜ï¼ˆéœ€è¦æ”¹è¿›ï¼‰

1. **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šéœ€è¦æ›´å¥½çš„é”™è¯¯æ¢å¤å’Œé™çº§ç­–ç•¥
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šéœ€è¦å¤„ç†å¤§å­—æ®µå’Œç¼“å­˜ä¸€è‡´æ€§
3. **ç›‘æ§å’Œå‘Šè­¦**ï¼šéœ€è¦å¯è§‚æµ‹æ€§æœºåˆ¶

### è®¾è®¡æ”¹è¿›å»ºè®®

1. **å¼•å…¥äº‹ä»¶ç‰ˆæœ¬å·**ï¼šä½¿ç”¨ä¹è§‚é”é˜²æ­¢å¹¶å‘å†²çª
2. **å®ç° Summary åˆå¹¶ç­–ç•¥**ï¼šè€Œä¸æ˜¯ç®€å•è¦†ç›–
3. **æ·»åŠ è¾“å…¥/è¾“å‡ºéªŒè¯**ï¼šå‡å°‘ LLM é”™è¯¯çš„å½±å“
4. **å®ç°äº‹ä»¶è¾¹ç•Œè§„åˆ™**ï¼šæä¾›æ˜ç¡®çš„åˆ’åˆ†æ ‡å‡†
5. **æ·»åŠ ç›‘æ§æŒ‡æ ‡**ï¼šè·Ÿè¸ªç³»ç»Ÿå¥åº·çŠ¶æ€
6. **å®ç°è¡¥å¿æœºåˆ¶**ï¼šå¤„ç†éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ

---

## å…«ã€å…·ä½“ä¿®å¤å»ºè®®

### 8.1 ä¿®å¤å¹¶å‘æ›´æ–°å†²çª

```python
# å»ºè®®ï¼šä½¿ç”¨ä¹è§‚é”
class EpisodicEvent(SqlalchemyBase):
    version: Mapped[int] = mapped_column(Integer, default=0)
    
def update_event(self, event_id, new_summary, new_details, actor):
    with self.session_maker() as session:
        event = session.query(EpisodicEvent).filter(
            EpisodicEvent.id == event_id
        ).with_for_update().one()  # æ‚²è§‚é”
        
        # æˆ–ä½¿ç”¨ä¹è§‚é”
        old_version = event.version
        # ... æ›´æ–°é€»è¾‘ ...
        event.version = old_version + 1
        
        try:
            session.commit()
        except StaleDataError:
            # ç‰ˆæœ¬å†²çªï¼Œé‡è¯•æˆ–æŠ›å‡ºå¼‚å¸¸
            session.rollback()
            raise ConcurrentUpdateError("Event was modified by another transaction")
```

### 8.2 ä¿®å¤ Summary è¦†ç›–é—®é¢˜

```python
# å»ºè®®ï¼šå®ç°æ™ºèƒ½åˆå¹¶
def merge_summaries(old_summary: str, new_summary: str) -> str:
    # ä½¿ç”¨ LLM æˆ–è§„åˆ™å¼•æ“åˆå¹¶ï¼Œè€Œä¸æ˜¯ç®€å•è¦†ç›–
    # æˆ–è€…ä¿å­˜å†å²ç‰ˆæœ¬
    pass
```

### 8.3 æ·»åŠ ç›‘æ§

```python
# å»ºè®®ï¼šæ·»åŠ æŒ‡æ ‡æ”¶é›†
from prometheus_client import Counter, Histogram

merge_conflicts = Counter('episodic_memory_merge_conflicts', 'Number of merge conflicts')
update_latency = Histogram('episodic_memory_update_latency', 'Update operation latency')
```

